services:
  documenso-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: documenso
      POSTGRES_PASSWORD: documenso
      POSTGRES_DB: documenso
    ports:
      - "5433:5432"
    volumes:
      - documenso-pgdata:/var/lib/postgresql/data

  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "8025:8025"   # Web UI
      - "1025:1025"   # SMTP

  documenso-cert-init:
    image: alpine:3.20
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        if [ ! -f /certs/cert.p12 ]; then
          apk add --no-cache openssl > /dev/null 2>&1
          openssl req -x509 -newkey rsa:2048 -keyout /tmp/key.pem -out /tmp/cert.pem -days 3650 -nodes -subj "/CN=Doc Assembly Local/O=Doc Assembly/C=CL" 2>/dev/null
          openssl pkcs12 -export -out /certs/cert.p12 -inkey /tmp/key.pem -in /tmp/cert.pem -passout pass:documenso
          chmod 644 /certs/cert.p12
          rm /tmp/key.pem /tmp/cert.pem
          echo "cert.p12 generated"
        else
          echo "cert.p12 already exists"
        fi
    volumes:
      - documenso-certs:/certs

  documenso:
    image: documenso/documenso:latest
    ports:
      - "3000:3000"
    environment:
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=supersecret-for-local-dev-only
      - DATABASE_URL=postgresql://documenso:documenso@documenso-db:5432/documenso
      - NEXT_PRIVATE_DATABASE_URL=postgresql://documenso:documenso@documenso-db:5432/documenso
      - NEXT_PRIVATE_DIRECT_DATABASE_URL=postgresql://documenso:documenso@documenso-db:5432/documenso
      - NEXT_PRIVATE_ENCRYPTION_KEY=aH7kG2pL9mN4qR8sT1vW6xY0bC3dF5e
      - NEXT_PRIVATE_ENCRYPTION_SECONDARY_KEY=jK8nP3rV6wZ1cE4gI7lO0sU2xA5yB9d
      - NEXT_PUBLIC_WEBAPP_URL=http://localhost:3000
      - NEXT_PRIVATE_SMTP_HOST=mailpit
      - NEXT_PRIVATE_SMTP_PORT=1025
      - NEXT_PRIVATE_SMTP_FROM_ADDRESS=noreply@localhost
      - NEXT_PRIVATE_SMTP_FROM_NAME=Documenso
      - NEXT_PRIVATE_SIGNING_LOCAL_FILE_PATH=/app/certs/cert.p12
      - NEXT_PRIVATE_SIGNING_PASSPHRASE=documenso
    volumes:
      - documenso-certs:/app/certs:ro
    depends_on:
      documenso-cert-init:
        condition: service_completed_successfully
      documenso-db:
        condition: service_started
      mailpit:
        condition: service_started

volumes:
  documenso-pgdata:
  documenso-certs:

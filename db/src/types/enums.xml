<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ========== TENANCY ENUMs ========== -->

    <changeSet id="enum:workspace_type" author="doc-assembly">
        <comment>Workspace type: SYSTEM for template owners, CLIENT for end users</comment>
        <sql>CREATE TYPE workspace_type AS ENUM ('SYSTEM', 'CLIENT');</sql>
        <rollback>DROP TYPE IF EXISTS workspace_type;</rollback>
    </changeSet>

    <changeSet id="enum:workspace_status" author="doc-assembly">
        <comment>Workspace lifecycle status</comment>
        <sql>CREATE TYPE workspace_status AS ENUM ('ACTIVE', 'SUSPENDED', 'ARCHIVED');</sql>
        <rollback>DROP TYPE IF EXISTS workspace_status;</rollback>
    </changeSet>

    <!-- ========== IDENTITY ENUMs ========== -->

    <changeSet id="enum:system_role" author="doc-assembly">
        <comment>System-level roles for platform administration</comment>
        <sql>CREATE TYPE system_role AS ENUM ('SUPERADMIN', 'PLATFORM_ADMIN');</sql>
        <rollback>DROP TYPE IF EXISTS system_role;</rollback>
    </changeSet>

    <changeSet id="enum:tenant_role" author="doc-assembly">
        <comment>Tenant-level roles for tenant administration</comment>
        <sql>CREATE TYPE tenant_role AS ENUM ('TENANT_OWNER', 'TENANT_ADMIN');</sql>
        <rollback>DROP TYPE IF EXISTS tenant_role;</rollback>
    </changeSet>

    <changeSet id="enum:user_status" author="doc-assembly">
        <comment>User account status for shadow users</comment>
        <sql>CREATE TYPE user_status AS ENUM ('INVITED', 'ACTIVE', 'SUSPENDED');</sql>
        <rollback>DROP TYPE IF EXISTS user_status;</rollback>
    </changeSet>

    <changeSet id="enum:workspace_role" author="doc-assembly">
        <comment>Role levels within a workspace</comment>
        <sql>CREATE TYPE workspace_role AS ENUM ('OWNER', 'ADMIN', 'EDITOR', 'OPERATOR', 'VIEWER');</sql>
        <rollback>DROP TYPE IF EXISTS workspace_role;</rollback>
    </changeSet>

    <changeSet id="enum:membership_status" author="doc-assembly">
        <comment>Workspace membership status</comment>
        <sql>CREATE TYPE membership_status AS ENUM ('PENDING', 'ACTIVE');</sql>
        <rollback>DROP TYPE IF EXISTS membership_status;</rollback>
    </changeSet>

    <!-- ========== CONTENT ENUMs ========== -->

    <changeSet id="enum:injectable_data_type" author="doc-assembly">
        <comment>Data types for injectable variables</comment>
        <sql>CREATE TYPE injectable_data_type AS ENUM ('TEXT', 'NUMBER', 'DATE', 'CURRENCY', 'BOOLEAN', 'IMAGE', 'TABLE');</sql>
        <rollback>DROP TYPE IF EXISTS injectable_data_type;</rollback>
    </changeSet>

    <changeSet id="enum:injectable_source_type" author="doc-assembly">
        <comment>Source type for injectable: INTERNAL (system-calculated) or EXTERNAL (from external source/user input)</comment>
        <sql>CREATE TYPE injectable_source_type AS ENUM ('INTERNAL', 'EXTERNAL');</sql>
        <rollback>DROP TYPE IF EXISTS injectable_source_type;</rollback>
    </changeSet>

    <changeSet id="enum:version_status" author="doc-assembly">
        <comment>Template version lifecycle status: DRAFT (editing), SCHEDULED (awaiting activation), PUBLISHED (active), ARCHIVED (historical)</comment>
        <sql>CREATE TYPE version_status AS ENUM ('DRAFT', 'SCHEDULED', 'PUBLISHED', 'ARCHIVED');</sql>
        <rollback>DROP TYPE IF EXISTS version_status;</rollback>
    </changeSet>

    <!-- ========== EXECUTION ENUMs ========== -->

    <changeSet id="enum:recipient_status" author="doc-assembly">
        <comment>Document recipient signing status</comment>
        <sql>CREATE TYPE recipient_status AS ENUM ('WAITING', 'SIGNED', 'REJECTED');</sql>
        <rollback>DROP TYPE IF EXISTS recipient_status;</rollback>
    </changeSet>

    <changeSet id="enum:document_status" author="doc-assembly">
        <comment>Document signing workflow status</comment>
        <sql>CREATE TYPE document_status AS ENUM ('DRAFT', 'PENDING', 'IN_PROGRESS', 'COMPLETED', 'DECLINED', 'VOIDED', 'EXPIRED', 'ERROR');</sql>
        <rollback>DROP TYPE IF EXISTS document_status;</rollback>
    </changeSet>

    <changeSet id="enum:recipient_status:migrate_to_new_values" author="doc-assembly">
        <comment>Migrate recipient_status enum: WAITING->PENDING, REJECTED->DECLINED, add SENT, DELIVERED</comment>
        <sql splitStatements="false">
            -- Step 1: Create new enum with desired values
            CREATE TYPE recipient_status_new AS ENUM ('PENDING', 'SENT', 'DELIVERED', 'SIGNED', 'DECLINED');

            -- Step 2: Update default value (remove old default first)
            ALTER TABLE execution.document_recipients
                ALTER COLUMN status DROP DEFAULT;

            -- Step 3: Migrate data and change column type
            ALTER TABLE execution.document_recipients
                ALTER COLUMN status TYPE recipient_status_new
                USING (
                    CASE status::text
                        WHEN 'WAITING' THEN 'PENDING'::recipient_status_new
                        WHEN 'REJECTED' THEN 'DECLINED'::recipient_status_new
                        WHEN 'SIGNED' THEN 'SIGNED'::recipient_status_new
                        ELSE 'PENDING'::recipient_status_new
                    END
                );

            -- Step 4: Drop old enum and rename new one
            DROP TYPE recipient_status;
            ALTER TYPE recipient_status_new RENAME TO recipient_status;

            -- Step 5: Set new default
            ALTER TABLE execution.document_recipients
                ALTER COLUMN status SET DEFAULT 'PENDING'::recipient_status;
        </sql>
        <rollback>
            -- Recreate old enum
            CREATE TYPE recipient_status_old AS ENUM ('WAITING', 'SIGNED', 'REJECTED');

            ALTER TABLE execution.document_recipients
                ALTER COLUMN status DROP DEFAULT;

            ALTER TABLE execution.document_recipients
                ALTER COLUMN status TYPE recipient_status_old
                USING (
                    CASE status::text
                        WHEN 'PENDING' THEN 'WAITING'::recipient_status_old
                        WHEN 'DECLINED' THEN 'REJECTED'::recipient_status_old
                        WHEN 'SIGNED' THEN 'SIGNED'::recipient_status_old
                        ELSE 'WAITING'::recipient_status_old
                    END
                );

            DROP TYPE recipient_status;
            ALTER TYPE recipient_status_old RENAME TO recipient_status;

            ALTER TABLE execution.document_recipients
                ALTER COLUMN status SET DEFAULT 'WAITING'::recipient_status;
        </rollback>
    </changeSet>

</databaseChangeLog>

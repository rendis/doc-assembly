<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ========================================== -->
    <!-- Template Version Injectables - System Support -->
    <!-- ========================================== -->

    <!-- ========== ADD SYSTEM INJECTABLE KEY COLUMN ========== -->

    <changeSet id="template_version_injectables:add_column:system_injectable_key" author="doc-assembly">
        <comment>Add system_injectable_key column to support system-defined injectables</comment>
        <addColumn tableName="template_version_injectables" schemaName="content">
            <column name="system_injectable_key" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ========== MAKE INJECTABLE_DEFINITION_ID NULLABLE ========== -->

    <changeSet id="template_version_injectables:alter_column:injectable_definition_id_nullable" author="doc-assembly">
        <comment>Make injectable_definition_id nullable to allow system injectables</comment>
        <dropNotNullConstraint
            schemaName="content"
            tableName="template_version_injectables"
            columnName="injectable_definition_id"/>
    </changeSet>

    <!-- ========== ADD FK TO SYSTEM_INJECTABLE_DEFINITIONS ========== -->

    <changeSet id="template_version_injectables:add_fk_constraint:system_injectable_key" author="doc-assembly">
        <comment>FK to system_injectable_definitions</comment>
        <addForeignKeyConstraint
            baseTableSchemaName="content"
            baseTableName="template_version_injectables"
            baseColumnNames="system_injectable_key"
            constraintName="fk_template_version_injectables_system_injectable_key"
            referencedTableSchemaName="content"
            referencedTableName="system_injectable_definitions"
            referencedColumnNames="key"
            onDelete="RESTRICT"/>
    </changeSet>

    <!-- ========== ADD XOR CHECK CONSTRAINT ========== -->

    <changeSet id="template_version_injectables:check_constraint:injectable_source_xor" author="doc-assembly">
        <comment>Ensure exactly one of injectable_definition_id or system_injectable_key is set</comment>
        <sql>
            ALTER TABLE content.template_version_injectables
            ADD CONSTRAINT chk_injectable_source_xor CHECK (
                (injectable_definition_id IS NOT NULL AND system_injectable_key IS NULL) OR
                (injectable_definition_id IS NULL AND system_injectable_key IS NOT NULL)
            );
        </sql>
        <rollback>
            ALTER TABLE content.template_version_injectables DROP CONSTRAINT chk_injectable_source_xor;
        </rollback>
    </changeSet>

    <!-- ========== ADD INDEX FOR SYSTEM_INJECTABLE_KEY ========== -->

    <changeSet id="template_version_injectables:index_creation:system_injectable_key" author="doc-assembly">
        <comment>Index for system injectable key lookups</comment>
        <createIndex indexName="idx_template_version_injectables_system_injectable_key" tableName="template_version_injectables" schemaName="content">
            <column name="system_injectable_key"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>

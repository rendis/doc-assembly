<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ============================================ -->
    <!-- Injectable Definitions - Active & Soft Delete -->
    <!-- ============================================ -->

    <!-- ========== COLUMN ADDITIONS ========== -->

    <changeSet id="injectable_definitions:add_column:is_active" author="doc-assembly">
        <comment>Add is_active column to enable/disable injectables</comment>
        <addColumn tableName="injectable_definitions" schemaName="content">
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="injectable_definitions:add_column:is_deleted" author="doc-assembly">
        <comment>Add is_deleted column for soft delete (date tracked via updated_at)</comment>
        <addColumn tableName="injectable_definitions" schemaName="content">
            <column name="is_deleted" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="injectable_definitions:add_column:default_value" author="doc-assembly">
        <comment>Add default_value column for injectable default values</comment>
        <addColumn tableName="injectable_definitions" schemaName="content">
            <column name="default_value" type="TEXT">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ========== UNIQUE INDEX UPDATE ========== -->

    <changeSet id="injectable_definitions:drop_index:unique_key_old" author="doc-assembly">
        <comment>Drop old unique index to recreate with soft delete filter</comment>
        <sql>DROP INDEX IF EXISTS content.idx_injectable_definitions_unique_key;</sql>
        <rollback>
            CREATE UNIQUE INDEX idx_injectable_definitions_unique_key
            ON content.injectable_definitions (COALESCE(workspace_id, '00000000-0000-0000-0000-000000000000'::uuid), key);
        </rollback>
    </changeSet>

    <changeSet id="injectable_definitions:index_creation:unique_key_not_deleted" author="doc-assembly">
        <comment>Unique key per scope only for non-deleted records</comment>
        <sql>
            CREATE UNIQUE INDEX idx_injectable_definitions_unique_key
            ON content.injectable_definitions (COALESCE(workspace_id, '00000000-0000-0000-0000-000000000000'::uuid), key)
            WHERE is_deleted = FALSE;
        </sql>
        <rollback>DROP INDEX IF EXISTS content.idx_injectable_definitions_unique_key;</rollback>
    </changeSet>

    <!-- ========== ADDITIONAL INDEXES ========== -->

    <changeSet id="injectable_definitions:index_creation:is_active" author="doc-assembly">
        <comment>Index for filtering by active status</comment>
        <createIndex indexName="idx_injectable_definitions_is_active" tableName="injectable_definitions" schemaName="content">
            <column name="is_active"/>
        </createIndex>
    </changeSet>

    <changeSet id="injectable_definitions:index_creation:is_deleted" author="doc-assembly">
        <comment>Index for filtering by deleted status</comment>
        <createIndex indexName="idx_injectable_definitions_is_deleted" tableName="injectable_definitions" schemaName="content">
            <column name="is_deleted"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>

<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ========== TABLE CREATION ========== -->

    <changeSet id="tenants:table_creation" author="doc-assembly">
        <comment>Create tenants table - represents a jurisdiction, country or major business unit</comment>
        <createTable tableName="tenants" schemaName="tenancy">
            <column name="id" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(10)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="VARCHAR(500)">
                <constraints nullable="true"/>
            </column>
            <column name="is_system" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="settings" type="JSONB">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMPTZ"/>
        </createTable>
    </changeSet>

    <!-- ========== INDEXES ========== -->

    <changeSet id="tenants:index_creation:code" author="doc-assembly">
        <comment>Index for tenant code lookups</comment>
        <createIndex indexName="idx_tenants_code" tableName="tenants" schemaName="tenancy">
            <column name="code"/>
        </createIndex>
    </changeSet>

    <changeSet id="tenants:unique_partial_index:system_tenant" author="doc-assembly">
        <comment>Ensure only ONE system tenant exists (is_system = TRUE)</comment>
        <sql>
            CREATE UNIQUE INDEX idx_unique_system_tenant
            ON tenancy.tenants (is_system)
            WHERE is_system = TRUE;
        </sql>
        <rollback>DROP INDEX IF EXISTS tenancy.idx_unique_system_tenant;</rollback>
    </changeSet>

    <changeSet id="tenants:trgm_index_creation:name" author="doc-assembly">
        <comment>Trigram index for fuzzy tenant name search</comment>
        <sql>
            CREATE INDEX idx_tenants_name_trgm
            ON tenancy.tenants USING GIN (name gin_trgm_ops);
        </sql>
        <rollback>DROP INDEX IF EXISTS tenancy.idx_tenants_name_trgm;</rollback>
    </changeSet>

    <changeSet id="tenants:trgm_index_creation:code" author="doc-assembly">
        <comment>Trigram index for fuzzy tenant code search</comment>
        <sql>
            CREATE INDEX idx_tenants_code_trgm
            ON tenancy.tenants USING GIN (code gin_trgm_ops);
        </sql>
        <rollback>DROP INDEX IF EXISTS tenancy.idx_tenants_code_trgm;</rollback>
    </changeSet>

    <!-- ========== TRIGGERS ========== -->

    <changeSet id="tenants:trigger:updated_at" author="doc-assembly">
        <comment>Trigger to auto-update updated_at on modification</comment>
        <sql>
            CREATE TRIGGER trigger_tenants_updated_at
            BEFORE UPDATE ON tenancy.tenants
            FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
        </sql>
        <rollback>DROP TRIGGER IF EXISTS trigger_tenants_updated_at ON tenancy.tenants;</rollback>
    </changeSet>

    <changeSet id="tenants:function:protect_system_tenant" author="doc-assembly">
        <comment>Function to protect system tenant from DELETE and protected field UPDATE</comment>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION tenancy.protect_system_tenant()
            RETURNS TRIGGER AS $$
            BEGIN
                IF TG_OP = 'DELETE' THEN
                    IF OLD.is_system = TRUE THEN
                        RAISE EXCEPTION 'Cannot delete system tenant';
                    END IF;
                    RETURN OLD;
                ELSIF TG_OP = 'UPDATE' THEN
                    IF OLD.is_system = TRUE THEN
                        IF NEW.is_system != OLD.is_system OR
                           NEW.code != OLD.code OR
                           NEW.name != OLD.name THEN
                            RAISE EXCEPTION 'Cannot modify protected fields of system tenant';
                        END IF;
                    END IF;
                    RETURN NEW;
                END IF;
            END;
            $$ LANGUAGE plpgsql;
        </sql>
        <rollback>DROP FUNCTION IF EXISTS tenancy.protect_system_tenant();</rollback>
    </changeSet>

    <changeSet id="tenants:trigger:protect_system_tenant" author="doc-assembly">
        <comment>Trigger to protect system tenant</comment>
        <sql>
            CREATE TRIGGER trigger_protect_system_tenant
            BEFORE UPDATE OR DELETE ON tenancy.tenants
            FOR EACH ROW EXECUTE FUNCTION tenancy.protect_system_tenant();
        </sql>
        <rollback>DROP TRIGGER IF EXISTS trigger_protect_system_tenant ON tenancy.tenants;</rollback>
    </changeSet>

    <changeSet id="tenants:function:auto_create_system_workspace" author="doc-assembly">
        <comment>Auto-create SYSTEM workspace when tenant is created</comment>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION tenancy.auto_create_system_workspace()
            RETURNS TRIGGER AS $$
            BEGIN
                -- Skip for system tenant (workspace created via seed)
                IF NEW.is_system = FALSE THEN
                    INSERT INTO tenancy.workspaces (id, tenant_id, name, type, status)
                    VALUES (
                        gen_random_uuid(),
                        NEW.id,
                        NEW.name || ':System',
                        'SYSTEM',
                        'ACTIVE'
                    );
                END IF;
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
        </sql>
        <rollback>DROP FUNCTION IF EXISTS tenancy.auto_create_system_workspace();</rollback>
    </changeSet>

    <changeSet id="tenants:trigger:auto_create_system_workspace" author="doc-assembly">
        <comment>Trigger to auto-create SYSTEM workspace on tenant insert</comment>
        <sql>
            CREATE TRIGGER trigger_auto_create_system_workspace
            AFTER INSERT ON tenancy.tenants
            FOR EACH ROW EXECUTE FUNCTION tenancy.auto_create_system_workspace();
        </sql>
        <rollback>DROP TRIGGER IF EXISTS trigger_auto_create_system_workspace ON tenancy.tenants;</rollback>
    </changeSet>

    <!-- ========== STATUS ENUM AND COLUMN ========== -->

    <changeSet id="tenants:enum:tenant_status" author="doc-assembly">
        <comment>Create tenant status enum type</comment>
        <sql>CREATE TYPE tenancy.tenant_status AS ENUM ('ACTIVE', 'SUSPENDED', 'ARCHIVED');</sql>
        <rollback>DROP TYPE IF EXISTS tenancy.tenant_status;</rollback>
    </changeSet>

    <changeSet id="tenants:add_column:status" author="doc-assembly">
        <comment>Add status column to tenants table</comment>
        <sql>
            ALTER TABLE tenancy.tenants
            ADD COLUMN status tenancy.tenant_status NOT NULL DEFAULT 'ACTIVE';
        </sql>
        <rollback>ALTER TABLE tenancy.tenants DROP COLUMN IF EXISTS status;</rollback>
    </changeSet>

    <changeSet id="tenants:index:status" author="doc-assembly">
        <comment>Index for filtering tenants by status</comment>
        <createIndex indexName="idx_tenants_status" tableName="tenants" schemaName="tenancy">
            <column name="status"/>
        </createIndex>
    </changeSet>

    <!-- ========== SEED DATA ========== -->

    <changeSet id="tenants:seed:system_tenant" author="doc-assembly">
        <comment>Insert default system tenant</comment>
        <insert tableName="tenants" schemaName="tenancy">
            <column name="id" valueComputed="gen_random_uuid()"/>
            <column name="name" value="System"/>
            <column name="code" value="SYS"/>
            <column name="description" value="System tenant for global templates"/>
            <column name="is_system" valueBoolean="true"/>
        </insert>
    </changeSet>

</databaseChangeLog>

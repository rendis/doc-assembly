<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ============================================ -->
    <!-- Workspace Sandbox Feature                   -->
    <!-- Adds sandbox support for CLIENT workspaces  -->
    <!-- ============================================ -->

    <!-- ========== COLUMN ADDITIONS ========== -->

    <changeSet id="workspaces:add_column:is_sandbox" author="doc-assembly">
        <comment>Add is_sandbox column to identify sandbox workspaces</comment>
        <addColumn tableName="workspaces" schemaName="tenancy">
            <column name="is_sandbox" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="workspaces:add_column:sandbox_of_id" author="doc-assembly">
        <comment>Add sandbox_of_id column to reference parent workspace</comment>
        <addColumn tableName="workspaces" schemaName="tenancy">
            <column name="sandbox_of_id" type="UUID">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ========== FOREIGN KEYS ========== -->

    <changeSet id="workspaces:add_fk_constraint:sandbox_of_id" author="doc-assembly">
        <comment>FK to parent workspace with CASCADE delete</comment>
        <addForeignKeyConstraint
            baseTableSchemaName="tenancy"
            baseTableName="workspaces"
            baseColumnNames="sandbox_of_id"
            constraintName="fk_workspaces_sandbox_of"
            referencedTableSchemaName="tenancy"
            referencedTableName="workspaces"
            referencedColumnNames="id"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- ========== CHECK CONSTRAINTS ========== -->

    <changeSet id="workspaces:add_check_constraint:sandbox_requires_parent" author="doc-assembly">
        <comment>Ensure is_sandbox and sandbox_of_id are consistent</comment>
        <sql>
            ALTER TABLE tenancy.workspaces
            ADD CONSTRAINT chk_sandbox_requires_parent
            CHECK (
                (is_sandbox = FALSE AND sandbox_of_id IS NULL)
                OR
                (is_sandbox = TRUE AND sandbox_of_id IS NOT NULL)
            );
        </sql>
        <rollback>
            ALTER TABLE tenancy.workspaces DROP CONSTRAINT IF EXISTS chk_sandbox_requires_parent;
        </rollback>
    </changeSet>

    <!-- ========== INDEXES ========== -->

    <changeSet id="workspaces:index_creation:unique_sandbox_per_workspace" author="doc-assembly">
        <comment>Ensure only ONE sandbox per parent workspace</comment>
        <sql>
            CREATE UNIQUE INDEX idx_unique_sandbox_per_workspace
            ON tenancy.workspaces(sandbox_of_id)
            WHERE is_sandbox = TRUE;
        </sql>
        <rollback>DROP INDEX IF EXISTS tenancy.idx_unique_sandbox_per_workspace;</rollback>
    </changeSet>

    <changeSet id="workspaces:index_creation:sandbox_of_id" author="doc-assembly">
        <comment>Index for sandbox lookups</comment>
        <sql>
            CREATE INDEX idx_workspaces_sandbox_of_id
            ON tenancy.workspaces(sandbox_of_id)
            WHERE sandbox_of_id IS NOT NULL;
        </sql>
        <rollback>DROP INDEX IF EXISTS tenancy.idx_workspaces_sandbox_of_id;</rollback>
    </changeSet>

    <changeSet id="workspaces:index_creation:is_sandbox" author="doc-assembly">
        <comment>Index for filtering by sandbox status</comment>
        <createIndex indexName="idx_workspaces_is_sandbox" tableName="workspaces" schemaName="tenancy">
            <column name="is_sandbox"/>
        </createIndex>
    </changeSet>

    <!-- ========== FUNCTIONS AND TRIGGERS ========== -->

    <!-- Function: Create sandbox automatically -->
    <changeSet id="workspaces:function:create_workspace_sandbox" author="doc-assembly">
        <comment>Function to automatically create sandbox for CLIENT workspaces</comment>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION tenancy.create_workspace_sandbox()
            RETURNS TRIGGER AS $$
            BEGIN
                -- Only create sandbox for CLIENT workspaces that are NOT sandbox themselves
                IF NEW.type = 'CLIENT' AND NEW.is_sandbox = FALSE THEN
                    INSERT INTO tenancy.workspaces (
                        tenant_id,
                        name,
                        type,
                        status,
                        settings,
                        is_sandbox,
                        sandbox_of_id
                    ) VALUES (
                        NEW.tenant_id,
                        NEW.name || ' (SANDBOX)',
                        'CLIENT',
                        NEW.status,
                        NEW.settings,
                        TRUE,
                        NEW.id
                    );
                END IF;

                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
        </sql>
        <rollback>DROP FUNCTION IF EXISTS tenancy.create_workspace_sandbox();</rollback>
    </changeSet>

    <changeSet id="workspaces:trigger:create_workspace_sandbox" author="doc-assembly">
        <comment>Trigger to auto-create sandbox on workspace insert</comment>
        <sql>
            CREATE TRIGGER trigger_create_workspace_sandbox
            AFTER INSERT ON tenancy.workspaces
            FOR EACH ROW EXECUTE FUNCTION tenancy.create_workspace_sandbox();
        </sql>
        <rollback>DROP TRIGGER IF EXISTS trigger_create_workspace_sandbox ON tenancy.workspaces;</rollback>
    </changeSet>

    <!-- Function: Protect sandbox fields -->
    <changeSet id="workspaces:function:protect_sandbox_fields" author="doc-assembly">
        <comment>Function to protect sandbox workspace fields from direct modification</comment>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION tenancy.protect_sandbox_fields()
            RETURNS TRIGGER AS $$
            BEGIN
                -- Allow if in sync mode (session variable)
                IF current_setting('tenancy.sync_mode', TRUE) = 'true' THEN
                    RETURN NEW;
                END IF;

                -- If it's a sandbox, protect certain fields
                IF OLD.is_sandbox = TRUE THEN
                    -- Don't allow changing name directly
                    IF OLD.name IS DISTINCT FROM NEW.name THEN
                        RAISE EXCEPTION 'Cannot directly modify sandbox workspace name. Update the parent workspace instead.';
                    END IF;

                    -- Don't allow changing is_sandbox
                    IF OLD.is_sandbox IS DISTINCT FROM NEW.is_sandbox THEN
                        RAISE EXCEPTION 'Cannot change is_sandbox flag on a sandbox workspace.';
                    END IF;
                END IF;

                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
        </sql>
        <rollback>DROP FUNCTION IF EXISTS tenancy.protect_sandbox_fields();</rollback>
    </changeSet>

    <changeSet id="workspaces:trigger:protect_sandbox_fields" author="doc-assembly">
        <comment>Trigger to protect sandbox fields (runs BEFORE update)</comment>
        <sql>
            CREATE TRIGGER trigger_protect_sandbox_fields
            BEFORE UPDATE ON tenancy.workspaces
            FOR EACH ROW EXECUTE FUNCTION tenancy.protect_sandbox_fields();
        </sql>
        <rollback>DROP TRIGGER IF EXISTS trigger_protect_sandbox_fields ON tenancy.workspaces;</rollback>
    </changeSet>

    <!-- Function: Sync sandbox name -->
    <changeSet id="workspaces:function:sync_sandbox_name" author="doc-assembly">
        <comment>Function to sync sandbox name when parent name changes</comment>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION tenancy.sync_sandbox_name()
            RETURNS TRIGGER AS $$
            BEGIN
                -- If name changed on a CLIENT prod workspace, update its sandbox
                IF NEW.type = 'CLIENT'
                   AND NEW.is_sandbox = FALSE
                   AND OLD.name IS DISTINCT FROM NEW.name THEN
                    -- Enable sync mode to bypass protection
                    PERFORM set_config('tenancy.sync_mode', 'true', TRUE);

                    UPDATE tenancy.workspaces
                    SET name = NEW.name || ' (SANDBOX)'
                    WHERE sandbox_of_id = NEW.id AND is_sandbox = TRUE;

                    -- Disable sync mode
                    PERFORM set_config('tenancy.sync_mode', 'false', TRUE);
                END IF;

                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
        </sql>
        <rollback>DROP FUNCTION IF EXISTS tenancy.sync_sandbox_name();</rollback>
    </changeSet>

    <changeSet id="workspaces:trigger:sync_sandbox_name" author="doc-assembly">
        <comment>Trigger to sync sandbox name on parent name change</comment>
        <sql>
            CREATE TRIGGER trigger_sync_sandbox_name
            AFTER UPDATE OF name ON tenancy.workspaces
            FOR EACH ROW
            WHEN (OLD.name IS DISTINCT FROM NEW.name)
            EXECUTE FUNCTION tenancy.sync_sandbox_name();
        </sql>
        <rollback>DROP TRIGGER IF EXISTS trigger_sync_sandbox_name ON tenancy.workspaces;</rollback>
    </changeSet>

    <!-- Function: Sync sandbox status -->
    <changeSet id="workspaces:function:sync_sandbox_status" author="doc-assembly">
        <comment>Function to sync sandbox status when parent status changes</comment>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION tenancy.sync_sandbox_status()
            RETURNS TRIGGER AS $$
            BEGIN
                -- If status changed on a prod workspace, update its sandbox
                IF NEW.is_sandbox = FALSE
                   AND OLD.status IS DISTINCT FROM NEW.status THEN
                    UPDATE tenancy.workspaces
                    SET status = NEW.status
                    WHERE sandbox_of_id = NEW.id AND is_sandbox = TRUE;
                END IF;

                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
        </sql>
        <rollback>DROP FUNCTION IF EXISTS tenancy.sync_sandbox_status();</rollback>
    </changeSet>

    <changeSet id="workspaces:trigger:sync_sandbox_status" author="doc-assembly">
        <comment>Trigger to sync sandbox status on parent status change</comment>
        <sql>
            CREATE TRIGGER trigger_sync_sandbox_status
            AFTER UPDATE OF status ON tenancy.workspaces
            FOR EACH ROW
            WHEN (OLD.status IS DISTINCT FROM NEW.status)
            EXECUTE FUNCTION tenancy.sync_sandbox_status();
        </sql>
        <rollback>DROP TRIGGER IF EXISTS trigger_sync_sandbox_status ON tenancy.workspaces;</rollback>
    </changeSet>

    <!-- Function: Sync all sandboxes (manual repair) -->
    <changeSet id="workspaces:function:sync_workspace_sandboxes" author="doc-assembly">
        <comment>Function to sync/repair sandboxes: create missing and fix names</comment>
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION tenancy.sync_workspace_sandboxes()
            RETURNS TABLE (
                action TEXT,
                workspace_id UUID,
                workspace_name VARCHAR,
                sandbox_id UUID,
                sandbox_name VARCHAR
            ) AS $$
            DECLARE
                r RECORD;
                new_sandbox_id UUID;
            BEGIN
                -- Enable sync mode to bypass protection
                PERFORM set_config('tenancy.sync_mode', 'true', TRUE);

                -- 1. Create missing sandboxes
                FOR r IN
                    SELECT w.id, w.tenant_id, w.name, w.status, w.settings
                    FROM tenancy.workspaces w
                    WHERE w.type = 'CLIENT'
                      AND w.is_sandbox = FALSE
                      AND NOT EXISTS (
                          SELECT 1 FROM tenancy.workspaces s
                          WHERE s.sandbox_of_id = w.id AND s.is_sandbox = TRUE
                      )
                LOOP
                    INSERT INTO tenancy.workspaces (
                        tenant_id, name, type, status, settings, is_sandbox, sandbox_of_id
                    ) VALUES (
                        r.tenant_id,
                        r.name || ' (SANDBOX)',
                        'CLIENT',
                        r.status,
                        r.settings,
                        TRUE,
                        r.id
                    )
                    RETURNING id INTO new_sandbox_id;

                    action := 'CREATED';
                    workspace_id := r.id;
                    workspace_name := r.name;
                    sandbox_id := new_sandbox_id;
                    sandbox_name := r.name || ' (SANDBOX)';
                    RETURN NEXT;
                END LOOP;

                -- 2. Fix desynchronized sandbox names
                FOR r IN
                    SELECT
                        p.id as prod_id,
                        p.name as prod_name,
                        s.id as sandbox_id,
                        s.name as sandbox_name,
                        p.name || ' (SANDBOX)' as expected_name
                    FROM tenancy.workspaces p
                    INNER JOIN tenancy.workspaces s ON s.sandbox_of_id = p.id AND s.is_sandbox = TRUE
                    WHERE p.type = 'CLIENT'
                      AND p.is_sandbox = FALSE
                      AND s.name != p.name || ' (SANDBOX)'
                LOOP
                    UPDATE tenancy.workspaces
                    SET name = r.expected_name
                    WHERE id = r.sandbox_id;

                    action := 'RENAMED';
                    workspace_id := r.prod_id;
                    workspace_name := r.prod_name;
                    sandbox_id := r.sandbox_id;
                    sandbox_name := r.expected_name;
                    RETURN NEXT;
                END LOOP;

                -- Disable sync mode
                PERFORM set_config('tenancy.sync_mode', 'false', TRUE);

                RETURN;
            END;
            $$ LANGUAGE plpgsql;

            COMMENT ON FUNCTION tenancy.sync_workspace_sandboxes() IS
            'Synchronizes sandboxes for CLIENT workspaces: creates missing ones and fixes desynchronized names.
            Usage: SELECT * FROM tenancy.sync_workspace_sandboxes();';
        </sql>
        <rollback>DROP FUNCTION IF EXISTS tenancy.sync_workspace_sandboxes();</rollback>
    </changeSet>

    <!-- ========== DATA MIGRATION ========== -->

    <changeSet id="workspaces:data_migration:sync_existing_sandboxes" author="doc-assembly">
        <comment>Create sandboxes for existing CLIENT workspaces</comment>
        <sql>
            -- Run sync function to create sandboxes for existing workspaces
            SELECT * FROM tenancy.sync_workspace_sandboxes();
        </sql>
        <rollback>
            -- Remove all sandbox workspaces
            DELETE FROM tenancy.workspaces WHERE is_sandbox = TRUE;
        </rollback>
    </changeSet>

</databaseChangeLog>
